<!DOCTYPE html>
<!--Requires HTML5 + ES7 JavaScript-->
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <link rel="stylesheet" type="text/css" href="toggle-switchy.css">
    <link rel="stylesheet" type="text/css" href="u_lukas_style.css">

    <script>
        // Global object storing the application state, this is updated from
        // server PUSH updates via the SSE event handler.
        let app_state = {};

        async function do_http_request(req_str) {
            try {
                const response = await fetch(req_str);
                if (!response.ok) {
                    throw new Error('Network error.');
                }
                //alert(await response.text());
            } catch (err) {
                alert(err);
            }
        }

        async function submit_formdata(event) {
            event.preventDefault(); // Disable default "GET" form action
            const form_data = new FormData(event.target);
            // form_data.forEach(console.log);
            const req_str = "cmd?" + new URLSearchParams(form_data).toString();
            await do_http_request(req_str);
        }

        // Sends control name and value pair
        async function submit_single_ctrl(event) {
            // These elements are supposed to reflect the remote state and are
            // set later when the respective SSE event arrives with a state update
            event.preventDefault();
            target = event.target;
            all_ctrls = Array.from(document.getElementsByClassName("request_src"));
            if (src_els.includes(target)) {
                const req_str = "cmd?" + target.name + "=" + target.value;
                await do_http_request(req_str);
            }
        }


        // Connect all document forms submit action
        document.addEventListener("submit", submit_formdata, true);
        // Connect single control click events
        document.addEventListener("click", submit_single_ctrl, true);


        // Set connection state display to "nok" when heartbeats are missing
        class HeartbeatWatchdog {
            constructor(timeout) {
                this.timeout = timeout;
                this.view = document.getElementById("connection_vw");
                this.timer_id = this.start_timer();
                this.reset_cb = event => this.reset(event.data);
            }
            start_timer() {
                return window.setTimeout(() => this.set_nok(), this.timeout);
            }
            reset(data) {
                if (data == "HB") {
                    window.clearTimeout(this.timer_id);
                    this.set_ok();
                    this.timer_id = this.start_timer();
                }
            }
            set_nok() {
                this.view.setAttribute("state", "nok");
                this.view.innerHTML = "No Connection <br> to Hardware!";
            }
            set_ok() {
                this.view.setAttribute("state", "ok");
                this.view.innerHTML = "OK";
            }
        }


        // Update view with app state telegram when pushed via SSE
        class ViewUpdater {
            constructor() {
                this.power_bridge_vw = document.getElementById("power_pwm_enable_vw");
                this.shutdown_vw = document.getElementById("shutdown_vw");
                this.fan_vw = document.getElementById("fan_vw");
                this.ref_vw = document.getElementById("ref_vw");
                this.dut_vw = document.getElementById("dut_vw");
                this.current_limit_vw
            }
            update() {
                if (app_state.power_pwm_enabled) {
                    this.power_bridge_vw.setAttribute("state", "on");
                    this.power_bridge_vw.innerText = "Output: ON";
                } else {
                    this.power_bridge_vw.setAttribute("state", "off");
                    this.power_bridge_vw.innerText = "Output: OFF";
                }
                if (app_state.hw_shutdown_active) {
                    this.shutdown_vw.setAttribute("state", "nok");
                    this.shutdown_vw.innerHTML = "HW FAULT <br> SHUTDOWN ACTIVE!";
                } else {
                    this.shutdown_vw.setAttribute("state", "ok");
                    this.shutdown_vw.innerText = "State: Normal";
                }
                this.fan_vw.checked = Boolean(app_state.fan_active);
                this.ref_vw.checked = Boolean(app_state.output_ref_active);
                this.dut_vw.checked = Boolean(app_state.output_dut_active);
                // Operational settings
            }
        }


        // Connect Server-Sent Events, with auto-reconnect timer
        class ServerSentEventHandler {
            constructor(endpoint, reconnect_timeout,
                heartbeat_watchdog, view_updater) {
                this.endpoint = endpoint;
                this.heartbeat_watchdog = heartbeat_watchdog;
                this.view_updater = view_updater;
                this.source = null;
                const timeout = reconnect_timeout;
                this.reconnect_timer = () => window.setTimeout(
                    () => this.connect(), timeout
                );
                this.connect();
            }
            connect() {
                if (this.source != null) {
                    console.log("Reconnecting Server-Sent Events...");
                    this.source.close();
                } else {
                    console.log("Connecting Server-Sent Events...");
                }
                this.source = new EventSource(this.endpoint);
                this.source.addEventListener(
                    "heartbeat", this.heartbeat_watchdog.reset_cb, false);
                this.source.addEventListener(
                    "open", event => { console.log("Events Connected"); },
                    false
                );
                this.source.addEventListener(
                    "error", event => {
                        if (event.target.readyState != EventSource.OPEN) {
                            console.log("Events Disconnected!");
                            // Start Auto-Reconnect
                            this.reconnect_timer();
                        }
                    },
                    false
                );
                this.source.addEventListener(
                    "app_state", event => {
                        // console.log(`App State: "${event.data}"`);
                        // Set global object
                        app_state = JSON.parse(event.data);
                        this.view_updater.update();
                    }, false
                );
            } // connect()
        }
    </script>
</head>



<body>
    <img src="logo.svg" alt="Application Logo">

    <!--Responsive flow flex box for main content-->
    <div class="flex-flow">
    <div class="flex-one-item-center">
    <table>
        <thead>
            <tr>
                <th colspan="4">Operation Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Network Connection</td>
                <td>Power Output State</td>
                <td>HW Error Shutdown</td>
                <td>Heatsink Fan</td>
            </tr>

            <tr>
                <td>
                    <div class="bool_vw flex-centered" id="connection_vw" state="nok">
                        No Connection to Hardware!
                    </div>
                </td>
                <td>
                    <div class="bool_vw flex-centered" id="power_bridge_vw" state="na">
                        Unknown...
                    </div>
                </td>
                <td>
                    <div class="bool_vw flex-centered" id="shutdown_vw" state="na">
                        Unknown...
                        <input type="button" class="btn_full request_src"
                                name="clear_shutdown" value="true">
                    </div>
                </td>
                <td>
                    <label class="toggle-switchy" data-size="sm">
                        <input type="checkbox" class="bool_vw" id="fan_vw"
                                name=fan_state value="on" checked>
                        <span class="toggle">
                            <span class="switch"></span>
                        </span>
                    </label>
                </td>
            </tr>
        </tbody>
    </table>
    </div>


    <div class="flex-two-items-center">
    <table>
        <thead>
            <tr>
                <th colspan="3">Power Output Switches</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Bridge Output Main Switch</td>
                <td>REF/CAL Load Switch</td>
                <td>DUT Switch</td>
            </tr>
            <tr>
                <td>
                    <input type="button" class="request_src" id="btn_on"
                            name="set_output" value="on">
                    <input type="button" class="request_src" id="btn_off"
                            name="set_output" value="off">
                </td>
                <td>
                    <label class="toggle-switchy">
                        <input type="checkbox" class="bool_vw request_src" id="ref_vw"
                                name=set_relay_ref value="on" state="na">
                        <span class="toggle">
                            <span class="switch"></span>
                        </span>
                    </label>
                </td>
                <td>
                    <label class="toggle-switchy">
                        <input type="checkbox" class="bool_vw request_src" id="dut_vw"
                                name=set_relay_dut value="on" state="na">
                        <span class="toggle">
                            <span class="switch"></span>
                        </span>
                    </label>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    </div>


    <div class="flex-two-items-center">
    <form name="dead_time_settings">
        <table>
            <caption>
                <small>Click the "Submit" button to update settings
                    for the remote component!</small>
            </caption>
            <thead>
                <tr>
                    <th colspan="4">Dead Time Settings</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Lag Leg (ZCS) Dead Time /ns:</td>
                    <td><input type="number"
                            name="set_lag_dt" value="125" min="6.25" max="1000" step="6.25"></td>
                </tr>
                <tr>
                    <td>Lead Leg (ZVS) Dead Time /ns:</td>
                    <td><input type="number"
                            name="set_lead_dt" value="125" min="6.25" max="1000" step="6.25"></td>
                </tr>
                <td colspan="2"><input type="submit" value="Submit"></td>
                </tr>
            </tbody>
        </table>
    </form>
    </div>


    <div class="flex-two-items-center">
    <form name="limit_values">
        <table>
            <thead>
                <tr>
                    <th colspan="2">Limit Values</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Current Limit /A:</td>
                    <td><input type="number"
                            name="set_curr_limit" value="35" min="5" max="100"></td>
                </tr>
                    <td colspan="2">
                        <input type="submit" value="Submit">
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
    </div>


    <div class="flex-two-items-center">
    <form name="operation_settings">
        <table>
            <thead>
                <tr>
                    <th colspan="2">Operation Settings</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Frequency /kHz:</td>
                    <td><input type="number"
                            name="set_frequency" value="100" min="5" max="1000"></td>
                </tr>
                <tr>
                    <td>Duty Cycle /%:</td>
                    <td>
                        <input type="number" name="set_duty" value="45" min="0" max="100">
                    </td>
                </tr>
                <td colspan="2"><input type="submit" value="Submit"></td>
                </tr>
            </tbody>
        </table>
    </form>
    </div>

    <!--End responsive flow box-->
    </div>

    <p>
        <a href="update.html">Perform OTA Firmware Upload</a>
    </p>
    <p>
        2020-08-19 Ulrich Lukas
    </p>

    <script>
        const heartbeat_watchdog = new HeartbeatWatchdog(1500);
        const view_updater = new ViewUpdater();
        const sse_handler = new ServerSentEventHandler(
            "/events", 3000, heartbeat_watchdog, view_updater);
    </script>
</body>

</html>