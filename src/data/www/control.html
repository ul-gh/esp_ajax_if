<!DOCTYPE html>
<!--Requires at least ES7 JavaScript-->
<!--2020-09-24 Ulrich Lukas-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <link rel="stylesheet" type="text/css" href="toggle-switchy.css">
    <link rel="stylesheet" type="text/css" href="u_lukas_style.css">

    <script>
        // Minimum delay between two requests sent to the HTTP server in ms
        const request_interval_min = 200;
        // Global object storing the application state, this is updated from
        // server PUSH updates via the SSE event handler.
        let remote_state = {};
        // Last edited input elements. These are blocked from receiving state
        // updates when they are being edited.
        let last_edited_input_els = [];
        // Requtest rate limiting for continuous inputs
        let rate_limit_timer_expired = true;

        async function do_http_request(req_str) {
            try {
                const response = await fetch(req_str);
                if (!response.ok) {
                    throw new Error('Network error.');
                }
                //alert(await response.text());
            } catch (err) {
                alert(err);
            }
        }

        async function submit_formdata(event) {
            event.preventDefault(); // Disable default "GET" form action
            const form_data = new FormData(event.target);
            const req_str = "cmd?" + new URLSearchParams(form_data).toString();
            await do_http_request(req_str);
        }

        // Sends control name and value pair for different DOM element used as input
        async function submit_single_ctrl(event) {
            const target = event.target;
            let all_ctrls = Array.from(document.getElementsByClassName("request_src"));
            for (let i=0; i < all_ctrls.length; i++) {
                let ctrl = all_ctrls[i];
                // An element "contains" itself so this yields a valid result
                // even when the control is a single HTML DOM element
                if (ctrl.contains(target)) {
                    if (ctrl.classList.contains("toggle-switchy")) {
                        // For these iputs, we use custom actions. The inputs
                        // are not immediately toggled visibly but only when an
                        // SSE response from the server is received.
                        event.preventDefault();
                        let input_el = ctrl.firstElementChild;
                        var disabled = input_el.hasAttribute("disabled");
                        var req_name = input_el.getAttribute("name");
                        // We want the state to toggle, requested state is inverted
                        if (input_el.checked) {
                            var req_value = "false";
                        } else {
                            var req_value = "true";
                        }
                    } else {
                        if (    event.type == "click"
                                && !ctrl.classList.contains("click_src")) {
                            return;
                        }
                        var disabled = ctrl.hasAttribute("disabled");
                        var req_name = ctrl.getAttribute("name");
                        var req_value = ctrl.getAttribute("value");
                    }
                    if (!disabled) {
                        let req_str = "cmd?" + req_name + "=" + req_value;
                        console.log("Event.target: ");
                        console.log(event.target);
                        console.log("Target: ");
                        console.log(target);
                        console.log("Control: ");
                        console.log(ctrl);
                        console.log("Request: " + req_str);
                        await do_http_request(req_str);
                    }
                }
            }
        }

        // Sends control name and value pair for range input change events
        async function submit_range_input(event) {
            console.log("Input event: ");
            console.log(event);
            const t = event.target;
            if (    t.nodeName == "INPUT" && t.type == "range"
                    && !t.hasAttribute("disabled")
                    && rate_limit_timer_expired) {
                rate_limit_timer_expired = false;
                window.setTimeout(() => rate_limit_timer_expired = true,
                                  request_interval_min
                                  )
                const req_str = "cmd?" + t.name + "=" + t.value;
                await do_http_request(req_str);
            }
        }

        // Connect all document forms submit action
        document.addEventListener("submit", submit_formdata, true);
        // Connect single control click events
        document.addEventListener("click", submit_single_ctrl, true);
        document.addEventListener(
            "keydown",
            (e) => {if (e.key == "Enter") {submit_single_ctrl(e);
        console.log("FOOOO______0000000000");
        console.log(e.target);}},
            true);
        // Connect range input change events
        document.addEventListener("input", submit_range_input, true);


        // Update view with app state telegram when pushed via SSE
        class ViewUpdater {
            constructor() {
                this.connection_vw = document.getElementById("connection_vw");
                this.power_pwm_vw = document.getElementById("power_pwm_vw");
                this.shutdown_vw = document.getElementById("shutdown_vw");
                this.aux_temp_vw = document.getElementById("aux_temp_vw");
                this.heatsink_temp_vw = document.getElementById("heatsink_temp_vw");
                this.fan_vw = document.getElementById("fan_vw");
                this.btn_pwm_on = document.getElementById("btn_pwm_on");
                this.btn_pwm_off = document.getElementById("btn_pwm_off");
                this.ref_vw = document.getElementById("ref_vw");
                this.dut_vw = document.getElementById("dut_vw");
                this.lead_dt_vw = document.getElementById("lead_dt_vw");
                this.lag_dt_vw = document.getElementById("lag_dt_vw");
                this.current_limit_vw = document.getElementById("current_limit_vw");
                this.frequency_number_vw = document.getElementById("frequency_number_vw");
                this.frequency_range_vw = document.getElementById("frequency_range_vw");
                this.duty_number_vw = document.getElementById("duty_number_vw");
                this.duty_range_vw = document.getElementById("duty_range_vw");
                this.all_remote_vws = [
                    this.power_pwm_vw, this.shutdown_vw, this.aux_temp_vw,
                    this.heatsink_temp_vw, this.fan_vw, this.ref_vw, this.dut_vw,
                    this.lead_dt_vw, this.lag_dt_vw, this.current_limit_vw,
                    this.frequency_number_vw, this.frequency_range_vw,
                    this.duty_number_vw, this.duty_range_vw,
                    this.btn_pwm_on, this.btn_pwm_off];
                // Prevent updating the input fields content with remote data
                // when user starts entering a new value.
                this.view_updates_inhibited = false;
                // Same but only inhibits range slider updates
                this.range_input_updates_inhibited = false;
                document.addEventListener(
                        "input",
                        (e) => {this.inhibit_view_updates(e.target);
                        },
                        true);
                // Allow again when editing is finished.
                document.addEventListener(
                        "submit",
                        (e) => this.allow_view_updates(e.target),
                        true);
                document.addEventListener(
                        "keydown",
                        (e) => {if (e.key == "Enter") {
                            console.log("ENTER pressed with value: " + e.target.value);
                            this.allow_view_updates(e.target);}},
                        true);
                document.addEventListener(
                        "change",
                        (e) => {const t = e.target;
                                if (t.nodeName == "INPUT" && t.type == "range") {
                                    this.allow_view_updates(t);
                                    }
                                },
                        true);
            }

            update() {
                if (this.view_updates_inhibited) {
                    return;
                } 
                if (remote_state.power_pwm_active) {
                    this.power_pwm_vw.setAttribute("active", "active");
                    this.power_pwm_vw.innerText = "Power PWM ON";
                } else {
                    this.power_pwm_vw.removeAttribute("active");
                    this.power_pwm_vw.innerText = "Power PWM OFF";
                }

                if (remote_state.hw_oc_fault_present) {
                    this.shutdown_vw.setAttribute("fault_present", "true");
                    this.shutdown_vw.innerText = "HW OC FAULT\nClick here to Reset!!";
                } else {
                    this.shutdown_vw.removeAttribute("fault_present")
                    if (remote_state.hw_oc_fault_occurred) {
                        this.shutdown_vw.setAttribute("fault_occurred", "true");
                        this.shutdown_vw.innerText = "HW OC fault latched!\nClick here to Reset!";
                    } else {
                        this.shutdown_vw.removeAttribute("fault_occurred");;
                        this.shutdown_vw.innerText = "State: Normal";
                    }
                }
                this.aux_temp_vw.innerText = Number(
                    remote_state.aux_temp).toFixed(1) + " °C";
                this.heatsink_temp_vw.innerText = Number(
                    remote_state.heatsink_temp).toFixed(1) + " °C";
                this.fan_vw.firstElementChild.checked = Boolean(
                    remote_state.fan_active);
                this.ref_vw.firstElementChild.checked = Boolean(
                    remote_state.relay_ref_active);
                this.dut_vw.firstElementChild.checked = Boolean(
                    remote_state.relay_dut_active);
                // Operational settings
                this.lag_dt_vw.value = remote_state.lag_dt.toFixed(0);
                this.lead_dt_vw.value = remote_state.lead_dt.toFixed(0);
                this.current_limit_vw.value = remote_state.current_limit.toFixed(1);
                this.frequency_number_vw.value = remote_state.frequency.toFixed(1);
                this.duty_number_vw.value = remote_state.duty.toFixed(1);
                if (!this.range_input_updates_inhibited) {
                    this.frequency_range_vw.value = remote_state.frequency.toFixed(1);
                    this.duty_range_vw.value = remote_state.duty.toFixed(1);
                }
            }

            enable_all() {
                this.connection_vw.setAttribute("active", "active");
                this.connection_vw.innerText = "OK";
                this.all_remote_vws.forEach((item) => {
                    if (item.classList.contains("toggle-switchy")) {
                        item.firstElementChild.disabled = false;
                    } else {
                        item.removeAttribute("disabled");
                    }
                });
            }

            disable_all() {
                this.connection_vw.removeAttribute("active");
                this.connection_vw.innerText = "No Connection\nto Hardware!";
                this.power_pwm_vw.innerText = "Unknown...";
                this.shutdown_vw.innerText = "Unknown...";
                this.aux_temp_vw.innerText = "Unknown...";
                this.heatsink_temp_vw.innerText = "Unknown...";
                this.all_remote_vws.forEach((item) => {
                    if (item.classList.contains("toggle-switchy")) {
                        item.firstElementChild.disabled = true;
                    } else {
                        item.setAttribute("disabled", "disabled");
                    }
                });
            }

            inhibit_view_updates(input_el) {
                if (input_el.type == "range") {
                    this.range_input_updates_inhibited = true;
                    return;
                }
                if (this.all_remote_vws.includes(input_el)) {
                    this.view_updates_inhibited = true;
                    // Sets color highlight while aditing element
                    input_el.setAttribute("editing", "editing");
                    last_edited_input_els.push(input_el);
                }
            }

            allow_view_updates(input_el) {
                // When range slider is released, re-allow updates for this only
                if (input_el.type == "range") {
                    this.range_input_updates_inhibited = false;
                    return;
                }
                // Otherwise, re-allow all
                this.view_updates_inhibited = false;
                for (let i = last_edited_input_els.length-1; i >= 0; i--) {
                    last_edited_input_els[i].removeAttribute("editing");
                    last_edited_input_els.pop();
                }
            }
        }


        // Connect Server-Sent Events, with auto-reconnect timer
        class ServerSentEventHandler {
            constructor(endpoint, reconnect_timeout,
                    heartbeat_watchdog, view_updater) {
                this.endpoint = endpoint;
                this.heartbeat_watchdog = heartbeat_watchdog;
                this.view_updater = view_updater;
                this.source = null;
                const timeout = reconnect_timeout;
                this.reconnect_timer = () => window.setTimeout(
                    () => this.connect(), timeout
                );
                this.connect();
            }

            connect() {
                if (this.source != null) {
                    console.log("Reconnecting Server-Sent Events...");
                    this.source.close();
                } else {
                    console.log("Connecting Server-Sent Events...");
                }
                this.source = new EventSource(this.endpoint);
                //this.source.addEventListener(
                //    "heartbeat", this.heartbeat_watchdog.reset_cb, false);
                this.source.addEventListener(
                    "open", event => { console.log("Events Connected"); },
                    false
                );
                this.source.addEventListener(
                    "error", event => {
                        if (event.target.readyState != EventSource.OPEN) {
                            console.log("Events Disconnected!");
                            // Start Auto-Reconnect
                            this.reconnect_timer_id = this.reconnect_timer();
                        }
                    },
                    false
                );
                this.source.addEventListener(
                    "hw_app_state", event => {
                        // Since app state update telegram is emitted
                        // periodically, we use this to reset the watchdog.
                        this.heartbeat_watchdog.reset("HB");
                        // console.log(`App State: "${event.data}"`);
                        // Set global object
                        remote_state = JSON.parse(event.data);
                        this.view_updater.update();
                    }, false
                );
            }
            disable_reconnect() {
                window.clearTimeout(this.reconnect_timer_id);
            }
        }


        // Set connection state display to "nok" when heartbeats are missing
        // TODO: Also integrate SSE reconnection here
        class HeartbeatWatchdog {
            constructor(timeout, view_updater) {
                this.timeout = timeout;
                this.view_updater = view_updater;
                this.timer_id = this.start_timer();
                this.reset_cb = event => this.reset(event.data);
            }

            start_timer() {
                return window.setTimeout(() => this.set_nok(), this.timeout);
            }

            reset(data) {
                if (data == "HB") {
                    window.clearTimeout(this.timer_id);
                    this.set_ok();
                    this.timer_id = this.start_timer();
                }
            }

            set_nok() {
                this.view_updater.disable_all();
            }

            set_ok() {
                this.view_updater.enable_all();
            }
        }
    </script>
</head>



<body>
    <img src="logo.svg" alt="Application Logo">

    <!--Responsive grid layout for main content-->
    <ul class="grid_container main_grid">

    <li class="grid_item lr_center">
    <table>
        <thead>
            <tr>
                <th colspan="3">Operation Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Network Connection</td>
                <td>Power Output State</td>
                <td>HW Error Shutdown</td>
            </tr>
            <tr>
                <td>
                    <div class="flex-centered state_vw" id="connection_vw">
                    </div>
                </td>
                <td>
                    <div class="flex-centered state_vw" id="power_pwm_vw" disabled>
                    </div>
                </td>
                <td>
                    <div class="flex-centered state_vw request_src click_src" id="shutdown_vw"
                            name="clear_shutdown" value="true" disabled>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    </li>

    <li class="grid_item lr_center">
        <table>
            <thead>
                <tr>
                    <th colspan="3">Temperatures and Fan</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>AUX Temp</td>
                    <td>Heatsink Temp</td>
                    <td>Heatsink Fan</td>
                </tr>
                <tr>
                    <td>
                        <div class="flex-centered number_vw" id="aux_temp_vw">
                        </div>
                    </td>
                    <td>
                        <div class="flex-centered number_vw" id="heatsink_temp_vw" disabled>
                        </div>
                    </td>
                    <td>
                        <label class="toggle-switchy request_src" id="fan_vw">
                            <input type="checkbox" name="set_fan_active" checked disabled>
                            <span class="toggle">
                                <span class="switch"></span>
                            </span>
                        </label>
                    </td>
                </tr>
            </tbody>
        </table>
    </li>

    <li class="grid_item lr_center">
    <table>
        <thead>
            <tr>
                <th colspan="3">Power Output Switches</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Power PWM Main Switch</td>
                <td>REF/CAL Load Switch</td>
                <td>DUT Switch</td>
            </tr>
            <tr>
                <td>
                    <span style="white-space: nowrap">
                    <button class="request_src click_src" id="btn_pwm_on"
                            name="set_power_pwm_active" value="true" disabled>
                        ON
                    </button>
                    <button class="request_src click_src" id="btn_pwm_off"
                            name="set_power_pwm_active" value="false" disabled>
                        OFF
                    </button>
                    </span>
                </td>
                <td>
                    <label class="toggle-switchy request_src" id="ref_vw" data-size="lg">
                        <input type="checkbox" name="set_relay_ref_active" disabled>
                        <span class="toggle">
                            <span class="switch"></span>
                        </span>
                    </label>
                </td>
                <td>
                    <label class="toggle-switchy request_src" id="dut_vw" data-size="lg">
                        <input type="checkbox" name="set_relay_dut_active" disabled>
                        <span class="toggle">
                            <span class="switch"></span>
                        </span>
                    </label>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    </li>


    <li class="grid_item lr_center">
    <form name="dead_time_settings">
        <table>
            <thead>
                <tr>
                    <th colspan="4">Dead Time Settings</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Lag Leg (ZCS) Dead Time /ns:</td>
                    <td><input type="number" id="lag_dt_vw"
                            name="set_lag_dt" value="125" min="6" max="1000"></td>
                </tr>
                <tr>
                    <td>Lead Leg (ZVS) Dead Time /ns:</td>
                    <td><input type="number" id="lead_dt_vw"
                            name="set_lead_dt" value="125" min="6" max="1000"></td>
                </tr>
                <tr>
                <td colspan="2"><input id="debug" type="submit" value="Submit"></td>
                </tr>
            </tbody>
        </table>
    </form>
    </li>


    <li class="grid_item lr_center">
    <form name="limit_values">
        <table>
            <thead>
                <tr>
                    <th colspan="2">Limit Values</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Current Limit /A:</td>
                    <td><input type="number" id="current_limit_vw"
                            name="set_current_limit" value="35" min="0" max="100" step=0.1></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="submit" value="Submit">
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
    </li>


    <li class="grid_item lr_center">
        <table>
            <thead>
                <tr>
                    <th colspan="2">Operation Settings</th>
                </tr>
            </thead>
            <tbody>
                <tr class="alternating_bg">
                    <td>Frequency /kHz:</td>
                    <td><input type="number" class="request_src" id="frequency_number_vw"
                            name="set_frequency" value="100" min="5" max="1000" step=0.1>
                    </td>
                </tr>
                <tr class="alternating_bg">
                    <td colspan="2">
                        <input type="range" id="frequency_range_vw"
                            name="set_frequency" value="100" min="5" max="1000" step=0.1>
                    </td>
                </tr>
                
                <tr class="alternating_bg">
                    <td>Duty Cycle /%:</td>
                    <td>
                        <input type="number" class="request_src" id="duty_number_vw"
                            name="set_duty" value="45" min="0" max="100" step=0.1>
                    </td>
                </tr>
                <tr class="alternating_bg">
                    <td colspan="2">
                        <input type="range" id="duty_range_vw"
                            name="set_duty" value="45" min="0" max="100" step=0.1>
                    </td>
                </tr>
            </tbody>
        </table>
    </li>

    <!--End responsive grid layout-->
    </ul>

    <p>
        <a href="update.html">Perform OTA Firmware Upload</a>
    </p>
    <p>
        2020-09-01 Ulrich Lukas
    </p>

    <script>
        const view_updater = new ViewUpdater();
        view_updater.disable_all();
        const heartbeat_watchdog = new HeartbeatWatchdog(1500, view_updater);
        const sse_handler = new ServerSentEventHandler(
            "/events", 3000, heartbeat_watchdog, view_updater);
    </script>
</body>

</html>